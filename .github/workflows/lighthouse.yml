name: Lighthouse CI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      url:
        description: "URL to run Lighthouse on"
        required: false
        default: "http://localhost:8080"

permissions:
  issues: write
  contents: read

jobs:
  lighthouse-audit:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Project
        run: pnpm run build

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.14.x

      - name: Run Lighthouse CI
        id: lighthouse
        continue-on-error: true
        run: |
          lhci autorun --collect.staticDistDir=./dist --collect.numberOfRuns=3

      - name: Report Results to GitHub Issue
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const LHCI_DIR = '.lighthouseci';
            const THRESHOLDS = {
              LCP: { good: 2500, poor: 4000 },
              INP: { good: 200, poor: 500 },
              CLS: { good: 0.1, poor: 0.25 },
            };

            const getLatestReport = () => {
              try {
                const jsonReports = fs.readdirSync(LHCI_DIR).filter(f => f.endsWith('.json'));
                if (!jsonReports.length) return null;
                const latestReport = jsonReports.sort().reverse()[0];
                return JSON.parse(fs.readFileSync(path.join(LHCI_DIR, latestReport), 'utf8'));
              } catch (e) {
                console.error('Failed to read report:', e);
                return null;
              }
            };

            const formatScore = (val) => Math.round((val || 0) * 100);

            const getStatusIcon = (val, metric) => {
              if (!metric) return val >= 90 ? 'ğŸŸ¢' : val >= 50 ? 'ğŸŸ ' : 'ğŸ”´';
              const t = THRESHOLDS[metric];
              if (val <= t.good) return 'ğŸŸ¢';
              if (val <= t.poor) return 'ğŸŸ ';
              return 'ğŸ”´';
            };

            const formatMetricValue = (val, metric) => {
              if (val === undefined || val === null) return '-';
              if (metric === 'CLS') return val.toFixed(3);
              return `${(val / 1000).toFixed(2)}s`;
            };

            // í•™ìŠµ ì¤‘ì‹¬ì˜ í”¼ë“œë°± ìƒì„± í•¨ìˆ˜
            const generateFeedback = (webVitals, scores) => {
              let feedback = [];
              
              // LCP ë¶„ì„
              if (webVitals.LCP > THRESHOLDS.LCP.good) {
                feedback.push(`### âš ï¸ **LCP ìµœì í™” í•„ìš” (${formatMetricValue(webVitals.LCP, 'LCP')})**`);
                feedback.push(`- **ë¶„ì„**: ì´ˆê¸° ë¡œë”© ì†ë„ê°€ ê¸°ì¤€ì¹˜ë³´ë‹¤ ëŠë¦½ë‹ˆë‹¤. API í˜¸ì¶œì´ ì§ë ¬(Waterfall)ë¡œ ì²˜ë¦¬ë˜ê³  ìˆê±°ë‚˜, ë¦¬ì†ŒìŠ¤ ë¡œë”© ìˆœì„œ ìµœì í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
                feedback.push(`- **í•™ìŠµ í¬ì¸íŠ¸**: \`Promise.all\`ì„ í†µí•œ ë³‘ë ¬ ì²˜ë¦¬ì™€ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ íë¦„ì„ ì ê²€í•´ ë³´ì„¸ìš”.`);
              }

              // INP ë¶„ì„
              if (webVitals.INP > THRESHOLDS.INP.good || scores.performance < 0.9) {
                 feedback.push(`### âš ï¸ **ë°˜ì‘ì„±(INP) ê°œì„  í•„ìš”**`);
                 feedback.push(`- **ë¶„ì„**: ì‚¬ìš©ì ì…ë ¥ì— ëŒ€í•œ ì‘ë‹µ ì§€ì—°ì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤. ë Œë”ë§ ê³¼ì •ì—ì„œ ë¶ˆí•„ìš”í•œ ì—°ì‚°ì´ ë°˜ë³µë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.`);
                 feedback.push(`- **í•™ìŠµ í¬ì¸íŠ¸**: ì»´í¬ë„ŒíŠ¸ ë¦¬ë Œë”ë§ ì›ë¦¬ë¥¼ ì´í•´í•˜ê³ , \`useMemo\`ë‚˜ \`React.memo\`ë¥¼ ì ì ˆíˆ ì ìš©í–ˆëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”.`);
              }

              // CLS ë¶„ì„
              if (webVitals.CLS > THRESHOLDS.CLS.good) {
                 feedback.push(`### âš ï¸ **ë ˆì´ì•„ì›ƒ ì•ˆì •ì„±(CLS) í™•ë³´ í•„ìš”**`);
                 feedback.push(`- **ë¶„ì„**: ë°ì´í„° ë¡œë”© ì „í›„ë¡œ í™”ë©´ ìš”ì†Œì˜ ìœ„ì¹˜ê°€ ë³€ê²½ë˜ê³  ìˆìŠµë‹ˆë‹¤.`);
                 feedback.push(`- **í•™ìŠµ í¬ì¸íŠ¸**: ìŠ¤ì¼ˆë ˆí†¤ UI ì ìš©ì´ë‚˜ ê³ ì •ëœ ë†’ì´ê°’(` + '`min-height`' + `) ì„¤ì •ì„ í†µí•´ ì‹œê°ì  ì•ˆì •ì„±ì„ ë†’ì—¬ë³´ì„¸ìš”.`);
              }

              // ìµœì í™” ì„±ê³µ ì‹œ
              if (feedback.length === 0) {
                feedback.push(`### âœ… **ì„±ëŠ¥ ìµœì í™” ëª©í‘œ ë‹¬ì„±**`);
                feedback.push(`ëª¨ë“  í•µì‹¬ ì§€í‘œ(Core Web Vitals)ê°€ ì•ˆì •ì ì…ë‹ˆë‹¤. ì„±ëŠ¥ ìµœì í™” ê¸°ë²•ì„ ì„±ê³µì ìœ¼ë¡œ ì´í•´í•˜ê³  ì ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.`);
              }

              return feedback.join('\n');
            };

            const report = getLatestReport();

            if (!report) {
              console.log('No Lighthouse report found.');
              return;
            }

            const categories = report.categories || {};
            const audits = report.audits || {};

            const scores = {
              performance: categories.performance?.score,
              accessibility: categories.accessibility?.score,
              bestPractices: categories['best-practices']?.score,
            };

            const webVitals = {
              LCP: audits['largest-contentful-paint']?.numericValue,
              INP: audits['experimental-interaction-to-next-paint']?.numericValue ?? audits['interactive']?.numericValue,
              CLS: audits['cumulative-layout-shift']?.numericValue,
            };

            const now = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            const feedbackMessage = generateFeedback(webVitals, scores);

            const body = `
            ## ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ë¦¬í¬íŠ¸
            > ì¸¡ì • ì¼ì‹œ: ${now}

            ${feedbackMessage}

            ---

            ### ì¸¡ì • ê²°ê³¼ ìš”ì•½
            | ì¹´í…Œê³ ë¦¬ | ì ìˆ˜ | ìƒíƒœ |
            |:---:|:---:|:---|
            | **Performance** | **${formatScore(scores.performance)}** | ${getStatusIcon(formatScore(scores.performance))} |
            | **Accessibility** | **${formatScore(scores.accessibility)}** | ${getStatusIcon(formatScore(scores.accessibility))} |
            | **Best Practices** | **${formatScore(scores.bestPractices)}** | ${getStatusIcon(formatScore(scores.bestPractices))} |

            ### Core Web Vitals
            | ì§€í‘œ | ì¸¡ì •ê°’ | ìƒíƒœ | ì„¤ëª… |
            |:---:|:---:|:---|:---|
            | **LCP** | ${formatMetricValue(webVitals.LCP, 'LCP')} | ${getStatusIcon(webVitals.LCP, 'LCP')} | ë¡œë”© ì†ë„ |
            | **INP** | ${formatMetricValue(webVitals.INP, 'INP')} | ${getStatusIcon(webVitals.INP, 'INP')} | ë°˜ì‘ì„± (TBT í¬í•¨) |
            | **CLS** | ${formatMetricValue(webVitals.CLS, 'CLS')} | ${getStatusIcon(webVitals.CLS, 'CLS')} | ì‹œê°ì  ì•ˆì •ì„± |

            <details>
            <summary>ì°¸ê³ : ì„±ëŠ¥ ì§€í‘œ ê¸°ì¤€</summary>

            - **LCP (Largest Contentful Paint)**: 2.5ì´ˆ ì´í•˜ ìš°ìˆ˜
            - **INP (Interaction to Next Paint)**: 200ms ì´í•˜ ìš°ìˆ˜
            - **CLS (Cumulative Layout Shift)**: 0.1 ì´í•˜ ìš°ìˆ˜
            </details>
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼ [${now}]`,
              body: body,
              labels: ['lighthouse', 'performance']
            });
